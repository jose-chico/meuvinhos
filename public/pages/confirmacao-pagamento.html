<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pagamento confirmado · Casa de Vinho</title>
  <link rel="stylesheet" href="idade.css" />
  <style>
    :root { --primary:#7d1737; --bg:#fafafa; --card:#fff; --muted:#666; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color:#222; }
    .wrap { max-width: 720px; margin: 40px auto; padding: 24px; background: var(--card); border: 1px solid #eee; border-radius: 10px; }
    h1 { margin: 0 0 12px; font-size: 24px; }
    p { margin: 10px 0; }
    .muted { color: var(--muted); font-size: 14px; }
    .actions { margin-top: 22px; display: flex; gap: 12px; flex-wrap: wrap; }
    .btn { padding: 10px 16px; border-radius: 8px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; }
    .btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .summary { margin-top: 18px; padding: 12px; background:#f9f9f9; border:1px solid #eee; border-radius:8px; }
    code { background:#f0f0f0; padding:2px 6px; border-radius:6px; }
  </style>
  <meta name="robots" content="noindex">
</head>
<body>
  <div class="wrap">
    <h1 id="title">Pagamento confirmado ✅</h1>
    <p id="lead">Obrigado pela sua compra! Estamos processando seu pedido.</p>

    <div class="summary">
      <p class="muted">ID da sessão: <code id="sessionId">carregando…</code></p>
      <p class="muted">Resumo do carrinho:<br><span id="cartSummary">lendo…</span></p>
    </div>

    <p class="muted" id="redirectMsg">Você será redirecionado para a página inicial em alguns segundos.</p>

    <div class="actions">
      <button class="btn primary" onclick="goHome()">Ir para a página inicial</button>
      <button class="btn" onclick="cancelRedirect()">Cancelar redirecionamento</button>
      <button class="btn" id="restartBtn" style="display:none" onclick="startCheckout()">Reiniciar checkout agora</button>
    </div>
  </div>

  <script>
    // Lê o session_id anexado pelo Stripe ao success_url
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session_id');
    document.getElementById('sessionId').textContent = sessionId || 'N/A';

    // Mostra um resumo simples do carrinho e limpa para evitar recompras acidentais
    try {
      const raw = localStorage.getItem('carrinho');
      if (raw) {
        const carrinho = JSON.parse(raw);
        const total = (carrinho?.reduce((acc, p) => acc + (typeof p.preco === 'number' ? p.preco : parseFloat(String(p.preco).replace(/\.(?=\d{3}(\D|$))/g, '').replace(',', '.')) || 0), 0) || 0).toFixed(2);
        const itens = carrinho?.map(p => `${p.nome} (R$ ${Number(p.preco).toFixed ? Number(p.preco).toFixed(2) : p.preco})`).join(', ');
        document.getElementById('cartSummary').textContent = itens ? `${itens} — Total R$ ${total}` : 'sem itens';
      } else {
        document.getElementById('cartSummary').textContent = 'sem itens';
      }
    } catch (e) {
      document.getElementById('cartSummary').textContent = 'não foi possível ler o carrinho';
    }

    // Se houver session_id, fluxo normal: limpar carrinho e redirecionar
    let timer;
    if (sessionId) {
      try { localStorage.removeItem('carrinho'); } catch {}
      timer = setTimeout(() => {
        window.location.href = '/pages/index.html';
      }, 4000);
    } else {
      // Sem session_id: mensagem clara e opção (e tentativa automática) de reiniciar checkout
      const title = document.getElementById('title');
      const lead = document.getElementById('lead');
      const redirectMsg = document.getElementById('redirectMsg');
      title.textContent = 'Não foi possível confirmar o pagamento';
      lead.textContent = 'Não encontramos o identificador da sessão (session_id). Podemos iniciar novamente o checkout com seu carrinho.';
      redirectMsg.textContent = 'Iniciaremos um novo checkout automaticamente em alguns segundos.';

      async function startCheckout() {
        try {
          const raw = localStorage.getItem('carrinho');
          const carrinho = raw ? JSON.parse(raw) : [];
          const products = Array.isArray(carrinho) ? carrinho : [];
          const total = Number((products.reduce((acc, p) => acc + (typeof p.preco === 'number' ? p.preco : parseFloat(String(p.preco).replace(/\.(?=\d{3}(\D|$))/g, '').replace(',', '.')) || 0), 0)).toFixed(2));

          if (!products.length || !Number.isFinite(total) || total <= 0) {
            alert('Seu carrinho está vazio ou inválido. Voltando ao carrinho.');
            window.location.href = '/pages/carrinho.html';
            return;
          }

          const resp = await fetch('/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ products, total, currency: 'BRL' })
          });
          const data = await resp.json();
          if (resp.ok && data?.url) {
            window.location.href = data.url;
          } else {
            throw new Error(data?.message || 'Falha ao iniciar checkout.');
          }
        } catch (e) {
          alert('Não foi possível reiniciar o checkout automaticamente. Você pode tentar novamente a partir do carrinho.');
        }
      }

      // Tentativa automática após 5s
      timer = setTimeout(startCheckout, 5000);

      // Expõe no escopo global para o botão
      window.startCheckout = () => { clearTimeout(timer); startCheckout(); };
    }

    function goHome() { clearTimeout(timer); window.location.href = '/pages/index.html'; }
    function cancelRedirect() { clearTimeout(timer); alert('Redirecionamento cancelado. Você pode continuar nesta página.'); }
  </script>
  <script src="idade.js" defer></script>
</body>
</html>
      const restartBtn = document.getElementById('restartBtn');
      restartBtn.style.display = 'inline-block';