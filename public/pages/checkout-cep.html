<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Checkout com CEP (pré-endereço)</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main class="cep-page">
      <div class="cep-card">
        <h2 style="color: var(--accent-contrast);">Informe seu CEP para realizar a entrega</h2>

        <form id="form" class="cep-form">
          <div class="row">
            <div class="col">
              <label for="name">Nome completo</label>
              <input id="name" name="name" type="text" placeholder="Seu nome" required />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="email">E-mail</label>
              <input id="email" name="email" type="email" placeholder="voce@email.com" required />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label for="cep">CEP</label>
              <input id="cep" name="cep" type="text" placeholder="00000-000" inputmode="numeric" maxlength="9" />
              <div class="hint">Digite 8 dígitos. Ex: 77022-386</div>
            </div>
            <div class="col">
              <label for="numero">Número</label>
              <input id="numero" name="numero" type="text" placeholder="123" />
            </div>
            <div class="col">
              <label for="complemento">Complemento</label>
              <input id="complemento" name="complemento" type="text" placeholder="Apto, bloco, referência" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label for="logradouro">Endereço, linha 1</label>
              <input id="logradouro" type="text" placeholder="Rua/Av" readonly />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="bairro">Bairro</label>
              <input id="bairro" type="text" placeholder="Bairro" readonly />
            </div>
            <div class="col">
              <label for="cidade">Cidade</label>
              <input id="cidade" type="text" placeholder="Cidade" readonly />
            </div>
            <div class="col">
              <label for="estado">Estado</label>
              <input id="estado" type="text" placeholder="UF" readonly />
            </div>
          </div>

          <div id="msg" class="error" style="display:none"></div>
          <div id="ok" class="success" style="display:none"></div>

          <div class="row" style="margin-top: 8px;">
            <button id="btn" class="submit-btn" type="submit">Ir para Stripe Checkout</button>
          </div>
        </form>
      </div>
    </main>

    <script>
      const $ = (sel) => document.querySelector(sel);
      const fmtCEP = (s) => {
        const d = String(s || '').replace(/\D/g, '').slice(0, 8);
        if (d.length > 5) return d.slice(0,5) + '-' + d.slice(5);
        return d;
      };

      function setMessage(type, text) {
        const msg = $('#msg');
        const ok = $('#ok');
        msg.style.display = 'none';
        ok.style.display = 'none';
        if (type === 'error') { msg.textContent = text; msg.style.display = 'block'; }
        if (type === 'success') { ok.textContent = text; ok.style.display = 'block'; }
      }

      async function lookupCEP(cepRaw) {
        const cep = String(cepRaw || '').replace(/\D/g, '');
        if (cep.length !== 8) return null;
        const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await r.json();
        if (!data || data.erro) return null;
        return data;
      }

      // Captura total via query string (vindo do carrinho)
      const totalFromQuery = new URLSearchParams(location.search).get('total');

      // Máscara e busca CEP
      $('#cep').addEventListener('input', async (e) => {
        const v = fmtCEP(e.target.value);
        e.target.value = v;
        const digits = v.replace(/\D/g, '');
        if (digits.length === 8) {
          setMessage('success', 'Buscando endereço pelo CEP...');
          try {
            const data = await lookupCEP(digits);
            if (!data) {
              setMessage('error', 'CEP inválido ou não encontrado.');
              $('#logradouro').value = '';
              $('#bairro').value = '';
              $('#cidade').value = '';
              $('#estado').value = '';
              return;
            }
            setMessage('success', 'Endereço encontrado. Confira os campos.');
            $('#logradouro').value = data.logradouro || '';
            $('#bairro').value = data.bairro || '';
            $('#cidade').value = data.localidade || '';
            $('#estado').value = data.uf || '';
          } catch (err) {
            console.error(err);
            setMessage('error', 'Erro ao consultar ViaCEP. Tente novamente.');
          }
        }
      });

      $('#form').addEventListener('submit', async (e) => {
        e.preventDefault();
        setMessage(null, '');
        const btn = $('#btn');
        btn.disabled = true;
        try {
          const name = $('#name').value.trim();
          const email = $('#email').value.trim();
          const cep = $('#cep').value.replace(/\D/g, '');
          const numero = $('#numero').value.trim();
          const complemento = $('#complemento').value.trim();
          const totalStr = totalFromQuery ? String(totalFromQuery).trim() : '';
          if (!name || !email) { setMessage('error', 'Informe nome e e-mail.'); btn.disabled = false; return; }
          if (cep.length !== 8) { setMessage('error', 'Informe um CEP válido com 8 dígitos.'); btn.disabled = false; return; }
          // Total é obtido do carrinho via query; não exigir no formulário

          const body = {
            name,
            email,
            cep,
            numero,
            complemento,
            currency: 'BRL',
          };
          if (totalStr) body.total = totalStr;

          const r = await fetch('/checkout/stripe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
          const data = await r.json();
          if (!r.ok || !data?.url) {
            throw new Error(data?.message || 'Falha ao iniciar checkout');
          }
          window.location.href = data.url;
        } catch (err) {
          console.error(err);
          setMessage('error', String(err?.message || err));
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>